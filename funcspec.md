### Webアプリケーション機能仕様書：Auto Capture Best Shot

#### 1. 概要
本アプリケーションは、スマートフォンのカメラとモーションセンサー（加速度・ジャイロ）を利用し、**手ブレが少ない安定した瞬間を自動で検知して写真を撮影・保存する**ツールです。ハイキング中などの移動時でも、ブレの少ない画像を効率的に収集することを目的としています。撮影後は、収集した画像をギャラリーで確認し、一括でダウンロードすることが可能です。

#### 2. 主な機能
- **センサー利用の事前チェック**: アプリケーション開始時に、センサーが利用可能か（物理的に存在し、ユーザーに許可されているか）をチェックします。
- **ブレの少ない瞬間の自動撮影**: 監視モードを開始すると、センサーデータからデバイスの「安定度」をリアルタイムに算出し、安定度が高いと判断された瞬間の画像を自動で保存します。
- **撮影頻度の制御**: 一度撮影した後、約5秒間のクールダウンタイムを設け、連続して撮影しすぎないように制御します。
- **撮影枚数の目標設定**: 目標の撮影枚数（デフォルト500枚）に達すると、自動的に監視を終了します。
- **撮影結果のギャラリー表示**: 監視終了後、撮影されたすべての画像をサムネイル一覧で表示し、タップで個別の画像を拡大確認できます。
- **一括ダウンロード**: ギャラリー画面から、撮影したすべての画像を一つのZIPファイルとしてまとめてダウンロードできます。

#### 3. 画面構成とワークフロー
本アプリケーションは、主に2つの画面（ビュー）で構成されています。

##### 3.1. 撮影画面 (`capture-container`)
アプリケーション起動時の初期画面です。

| 要素 | 説明 |
|:---|:---|
| `カメラ映像` | スマートフォンの背面カメラの映像をリアルタイムで表示します。 |
| `監視開始`ボタン | クリックすると、センサーチェックを経て自動撮影（監視モード）を開始します。 |
| `監視停止`ボタン | 監視モード中にクリックすると、撮影を中断します。監視モード中のみ有効化されます。 |
| `ステータス表示`エリア | 「準備中...」「監視を開始しました (X / 500)」「エラー」など、現在のアプリケーションの状態をユーザーに伝えます。 |
| `センサー許可`エリア | センサーへのアクセス許可の状態（granted/denied）を表示します。 |

**ワークフロー:**
1.  ユーザーが「監視開始」ボタンをタップします。
2.  システムはカメラとモーションセンサーへのアクセス許可を要求します。
3.  センサーが実際にデータを送信しているかを3秒間チェックします。
    - 利用不可の場合：エラーメッセージを表示し、処理を中断します。
    - 利用可能な場合：監視モードに移行します。
4.  監視モード中は、約5秒に1回の頻度で「安定した瞬間」を探し、条件を満たせば自動で写真を内部に保存します。保存枚数はステータス表示エリアに更新されます。
5.  ユーザーが「監視停止」ボタンをタップするか、目標枚数に達すると監視モードは終了し、ギャラリー画面に遷移します。

##### 3.2. ギャラリー画面 (`gallery-container`)
撮影終了後に表示される画面です。

| 要素 | 説明 |
|:---|:---|
| `全画像をZIPでダウンロード`ボタン | クリックすると、保存された全画像をZIPファイルに圧縮し、ダウンロードを開始します。 |
| `ギャラリー`エリア | 撮影された画像がサムネイルで一覧表示されます。 |

**ワークフロー:**
1.  ユーザーはサムネイルをタップして、特定の画像を拡大表示できます（モーダルウィンドウ）。
2.  拡大表示された画像は、モーダルウィンドウ外または閉じるボタンをタップすることで閉じられます。
3.  ユーザーは「全画像をZIPでダウンロード」ボタンをタップし、すべての画像をまとめて端末に保存できます。

#### 4. 技術仕様詳細

##### 4.1. 安定度判定ロジック
- **入力データ**: 加速度センサー（X, Y, Z軸）とジャイロセンサー（α, β, γ軸）の生データ。
- **計算処理**:
    1.  加速度の合成値から重力加速度（約9.8m/s²）の影響を減算し、純粋な動きの大きさ（`net_a`）を算出します。
    2.  ジャイロの角速度の合成値（`g`）を算出します。
    3.  これらの値を用いて「安定度スコア」を計算します。スコアは動きが小さいほど`1`に近づきます。
        - `Score = 1 / (1 + (0.5 * net_a) + (1.0 * g))`
- **判定**: 算出されたスコアが、事前に定められたしきい値（`STABILITY_THRESHOLD`、デフォルト0.95）を超えた場合、「安定した」と判断します。

##### 4.2. 画像の保存と管理
- **撮影**: `drawImage()`メソッドを使用し、`<video>`の現在のフレームを非表示の`<canvas>`に描画します。
- **保存**: `canvas.toDataURL()`メソッドを使用し、描画された画像をJPEG形式のBase64文字列に変換し、JavaScriptの配列（`savedImages`）に一時的に保存します。
- **永続化**: 画像データはアプリケーションがアクティブな間のみメモリ上に保持されます。ZIPダウンロード機能により、ユーザーが能動的に端末へ永続化させます。

##### 4.3. 外部ライブラリ
- **JSZip**: ZIPファイル圧縮のために使用。CDN経由で読み込みます。

#### 5. 実行環境と制約
- **必須要件**:
    - 加速度センサーおよびジャイロセンサーを搭載したデバイス（主にスマートフォン）。
    - カメラを搭載したデバイス。
    - `DeviceMotionEvent`, `DeviceOrientationEvent`, `navigator.mediaDevices.getUserMedia` APIをサポートするモダンなWebブラウザ（例: Chrome, Safari on iOS）。
- **制約事項**:
    - ユーザーがブラウザのタブを閉じたり、リロードしたりすると、撮影中にメモリ上に保存されていた画像データはすべて失われます。
    - センサーへのアクセス許可は、特にiOSではユーザー操作（ボタンのタップなど）を起点にしないと要求できないため、「監視開始」ボタンを押したタイミングで許可を求めます。
    - VGA解像度（640x480）での撮影を想定していますが、実際の解像度はデバイスのカメラ性能に依存する場合があります。